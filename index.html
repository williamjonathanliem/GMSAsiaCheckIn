<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AOG Conference Asia 2025, Check In</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0a0e1a">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" defer></script>
  <style>
    :root{ --bg:#0a0e1a; --panel:#0f1424; --card:#1a1f2e; --muted:#94a3b8; --text:#f1f5f9;
      --brand:#6366f1; --ok:#10b981; --err:#ef4444; --warn:#f59e0b; --hair:rgba(255,255,255,.08);
      --radius:20px; --shadow:0 20px 40px rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.2) }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; color:var(--text); background:
      radial-gradient(1400px 700px at 15% -15%, rgba(99,102,241,.25), transparent 65%),
      radial-gradient(1000px 600px at 85% 15%, rgba(129,140,248,.2), transparent 65%),
      radial-gradient(800px 400px at 50% 100%, rgba(139,92,246,.15), transparent 70%),
      linear-gradient(180deg, #0a0e1a 0%, #0f1424 30%, #1a1f2e 100%);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      min-height:100dvh; padding-bottom:calc(env(safe-area-inset-bottom,0px) + 16px); overflow-x:hidden }
    .shell{max-width:1200px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:20px}
    .header{display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--hair); border-radius:24px; padding:20px 24px; box-shadow:var(--shadow), 0 0 0 1px rgba(255,255,255,.05) inset}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px; font-size:clamp(20px, 4vw, 24px);
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text}
    .logo{width:40px; height:40px; border-radius:8px; object-fit:contain; box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .grid{display:grid; gap:20px; grid-template-columns:1fr} @media(min-width:1024px){ .grid{ grid-template-columns: 1fr 1fr } }
    .card{background:linear-gradient(135deg, var(--card) 0%, rgba(26,31,46,.8) 100%); border:1px solid var(--hair);
      border-radius:20px; box-shadow:var(--shadow), 0 0 0 1px rgba(255,255,255,.03) inset; padding:24px; backdrop-filter:blur(8px)}
    .card h3{margin:0 0 16px; font-size:18px; color:#e2e8f0; letter-spacing:.3px; font-weight:700}
    #reader{width:100%; aspect-ratio:1/1; border-radius:18px; overflow:hidden; background:linear-gradient(135deg, #0a0f1d 0%, #0f1424 100%);
      border:1px solid rgba(255,255,255,.1); box-shadow:0 8px 32px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.05) inset}
    .controls{display:grid; gap:12px; grid-template-columns:1fr 1fr 1fr; margin-top:16px}
    .controls.main-buttons{ grid-template-columns:1fr 1fr } @media(max-width:560px){ .controls,.controls.main-buttons{ grid-template-columns:1fr } }
    .btn,.filebtn{appearance:none; border:none; border-radius:16px; padding:14px 16px; font-weight:700; cursor:pointer; width:100%; font-size:15px}
    .btn.primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff}
    .btn.ghost{background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:#e2e8f0; border:1px solid rgba(255,255,255,.1)}
    .btn.warn{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%); color:#fff}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .filebtn{background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:#e2e8f0; border:1px solid rgba(255,255,255,.1); position:relative}
    .filebtn input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .pill{display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:999px; background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:#e2e8f0; font-size:13px; font-weight:600; border:1px solid rgba(255,255,255,.1)}
    .kv{display:grid; gap:12px; margin-top:16px}
    .kv-row{display:flex; gap:12px; align-items:flex-start; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.05)}
    .kv-row:last-child{border-bottom:none}
    .kv-key{min-width:100px; color:#94a3b8; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.5px}
    .kv-val{flex:1; word-break:break-word; color:#f1f5f9; font-weight:500; line-height:1.4}
    .chip{display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:999px; background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:#e2e8f0; border:1px solid rgba(255,255,255,.1); cursor:pointer; font-weight:600; font-size:14px}
    .status{min-height:28px; margin-top:12px; font-weight:700; font-size:14px; padding:8px 12px; border-radius:8px}
    .ok{color:var(--ok); background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.2)}
    .err{color:var(--err); background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.2)}
    .warntext{color:var(--warn); background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.2)}
    .raw{display:none; margin-top:8px; color:#cbd5e1; font-size:13px; word-break:break-word; background:rgba(15,23,42,.5); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,.05); font-family:Monaco, Menlo, Ubuntu Mono, monospace}
    .setup-grid{display:grid; gap:12px; grid-template-columns: 1fr 2fr auto} @media(max-width:720px){ .setup-grid{ grid-template-columns:1fr } }
    .input, .select{ width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f172a; color:#e2e8f0; font-weight:600}
    .hint{color:var(--muted); font-size:12px; margin-top:8px}

    /* gate overlay */
    .gate{ position:relative }
    .gate.locked::after{
      content:'Complete setup to continue';
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(8,13,26,.72); backdrop-filter: blur(4px);
      border-radius:20px; border:1px dashed rgba(255,255,255,.18);
      font-weight:800; letter-spacing:.3px
    }
    .gate.locked .btn, .gate.locked input[type="file"]{ pointer-events:none }
    .gate.locked .btn, .gate.locked .filebtn, .gate.locked input[type="file"]{ opacity:.4 }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header" role="banner">
      <div class="brand">
        <img src="Logo.png" alt="GMS Logo" class="logo" />
        <span>AOG Conference Asia 2025, Check In</span>
      </div>
    </header>

    <!-- Setup -->
    <section class="card" aria-labelledby="setupTitle">
      <h3 id="setupTitle">Setup, choose location and connect sheet</h3>
      <div class="setup-grid">
        <select id="org" class="select" aria-label="Choose GMS">
          <option value="">Choose your GMS</option>
          <option value="gms-kl">GMS KL</option>
          <option value="gms-taiwan">GMS Taiwan</option>
          <option value="rosc-singapore">ROSC Singapore</option>
          <option value="gms-hongkong">GMS Hongkong</option>
        </select>
        <input id="sheetInput" class="input" placeholder="Paste Google Sheet link or Sheet ID" aria-label="Sheet link or ID">
        <button id="saveSetup" class="btn primary">Save</button>
      </div>
      <div class="hint">Paste the full sheet URL or the ID only, the app will extract the ID automatically</div>
      <div id="setupStatus" class="status" style="margin-top:8px"></div>
    </section>

    <main class="grid" role="main" aria-label="Check in workspace">
      <!-- Left -->
      <section class="card gate locked" aria-labelledby="scanTitle" id="scanCard">
        <h3 id="scanTitle">Scan or upload</h3>
        <div id="reader" aria-label="QR scanner area"></div>
        <div class="controls main-buttons" style="margin-top:12px">
          <button id="start" class="btn primary" disabled>Start camera</button>
          <label class="filebtn">Attach file
            <input id="file" type="file" accept="image/jpeg,image/png" aria-label="Attach QR image" disabled>
          </label>
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="stop" class="btn ghost" style="display:none">Stop camera</button>
          <button id="restart" class="btn ghost" style="display:none">Refit view</button>
          <div></div>
        </div>
        <div class="hint">Allow the camera when asked, or attach a QR image file</div>
      </section>

      <!-- Right -->
      <section class="card gate locked" aria-labelledby="reviewTitle" id="reviewCard">
        <h3 id="reviewTitle">Review and check in</h3>
        <div id="pill" class="pill">Waiting for scan</div>

        <div id="kv" class="kv" style="display:none">
          <div class="kv-row"><div class="kv-key">Name</div><div id="kvName" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Uni</div><div id="kvUni" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Number</div><div id="kvPhone" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Email</div><div id="kvEmail" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">CG</div><div id="kvCg" class="kv-val"></div></div>
          <details class="kv-more">
            <summary>More details</summary>
            <div class="kv" style="margin-top:8px">
              <div class="kv-row"><div class="kv-key">Timestamp</div><div id="kvTs" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Joined</div><div id="kvCgJ" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Name</div><div id="kvCgN" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Allergies</div><div id="kvAll" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Receipt</div><div id="kvRec" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Payment</div><div id="kvPay" class="kv-val"></div></div>
            </div>
          </details>
        </div>

        <label class="chip" style="background:#16203a; margin-top:8px"><input id="toggleRaw" type="checkbox"> Show raw text</label>
        <div id="raw" class="raw"></div>

        <div class="chips" role="radiogroup" aria-label="Choose status column" style="margin-top:8px">
          <label class="chip"><input type="radio" name="target" value="toolkit" checked> Toolkit Status</label>
          <label class="chip"><input type="radio" name="target" value="event"> Event Status</label>
        </div>

        <div class="controls main-buttons" style="margin-top:12px">
          <button id="markPay" class="btn warn" disabled>Check Mistaken Payment</button>
          <button id="confirm" class="btn primary" disabled>Confirm check in</button>
        </div>
        <div class="controls" style="margin-top:8px; grid-template-columns:1fr">
          <button id="clear" class="btn ghost">Clear</button>
        </div>
        <div id="status" class="status"></div>
      </section>
    </main>
  </div>

  <script>
    const API_ENDPOINT = '/api/check-in';

    document.addEventListener('DOMContentLoaded', () => {
      // Setup controls
      const orgSel = document.getElementById('org');
      const sheetInput = document.getElementById('sheetInput');
      const saveSetup = document.getElementById('saveSetup');
      const setupStatus = document.getElementById('setupStatus');

      // Gate containers
      const scanCard = document.getElementById('scanCard');
      const reviewCard = document.getElementById('reviewCard');

      // Scanner and UI
      const startBtn = document.getElementById('start');
      const stopBtn  = document.getElementById('stop');
      const refitBtn = document.getElementById('restart');
      const fileInp  = document.getElementById('file');
      const confirmBtn = document.getElementById('confirm');
      const clearBtn   = document.getElementById('clear');
      const markPayBtn = document.getElementById('markPay');

      const pill   = document.getElementById('pill');
      const kvWrap = document.getElementById('kv');
      const kvName = document.getElementById('kvName');
      const kvUni  = document.getElementById('kvUni');
      const kvPhone= document.getElementById('kvPhone');
      const kvEmail= document.getElementById('kvEmail');
      const kvCg   = document.getElementById('kvCg');
      const kvTs   = document.getElementById('kvTs');
      const kvCgJ  = document.getElementById('kvCgJ');
      const kvCgN  = document.getElementById('kvCgN');
      const kvAll  = document.getElementById('kvAll');
      const kvRec  = document.getElementById('kvRec');
      const kvPay  = document.getElementById('kvPay');

      const rawToggle = document.getElementById('toggleRaw');
      const rawBox    = document.getElementById('raw');
      const statusEl  = document.getElementById('status');

      let scanner = null, running = false, lastScan = '';
      let currentCameraId = null, resizeTimer = null;

      // saved state
      const savedOrg = localStorage.getItem('gms.org') || '';
      const savedSheetId = localStorage.getItem('gms.sheetId') || '';
      if (savedOrg) orgSel.value = savedOrg;
      if (savedSheetId) sheetInput.value = savedSheetId;

      function extractSheetId(input){
        const s = String(input || '').trim();
        if (!s) return '';
        const m = s.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (m && m[1]) return m[1];
        if (/^[a-zA-Z0-9-_]{20,}$/.test(s)) return s;
        return '';
      }

      function setupComplete(){
        const org = orgSel.value;
        const id = extractSheetId(sheetInput.value);
        return !!org && !!id;
      }

      function applyGate(){
        const ok = setupComplete();
        // lock or unlock
        scanCard.classList.toggle('locked', !ok);
        reviewCard.classList.toggle('locked', !ok);
        // hard disable inputs
        startBtn.disabled = !ok;
        fileInp.disabled = !ok;
        confirmBtn.disabled = !ok || !lastScan;
        markPayBtn.disabled = !ok || !lastScan;
      }

      function saveSetupState(){
        const org = orgSel.value;
        const id = extractSheetId(sheetInput.value);
        if (!org){
          setupStatus.textContent = 'Choose your GMS';
          setupStatus.className = 'status err';
          applyGate();
          return;
        }
        if (!id){
          setupStatus.textContent = 'Enter a valid Sheet link or ID';
          setupStatus.className = 'status err';
          applyGate();
          return;
        }
        localStorage.setItem('gms.org', org);
        localStorage.setItem('gms.sheetId', id);
        setupStatus.textContent = 'Saved, Org, ' + orgSel.options[orgSel.selectedIndex].text + ', Sheet ID, ' + id;
        setupStatus.className = 'status ok';
        applyGate();
      }

      saveSetup.addEventListener('click', saveSetupState);
      orgSel.addEventListener('change', applyGate);
      sheetInput.addEventListener('input', applyGate);

      function getSheetIdForRequest(){
        const ls = localStorage.getItem('gms.sheetId') || '';
        const fromInput = extractSheetId(sheetInput.value);
        return extractSheetId(ls || fromInput);
      }

      function readerSize(){
        const el = document.getElementById('reader');
        const w = el.clientWidth || window.innerWidth;
        return Math.max(240, Math.min(640, Math.floor(w * 0.92)));
      }

      function parsePayload(s){
        let p = String(s || '').trim();
        try { const u = new URL(p); const d = u.searchParams.get('data'); if (d) p = decodeURIComponent(d); } catch(_){}
        p = p.replace(/\s*\|\s*/g, ' | ').replace(/\s+/g, ' ').trim();
        const parts = p.split(' | '); while (parts.length < 9) parts.push('');
        const [ts, name, phone, uni, cgJoined, cgName, allergy, receipt, email] = parts;
        let cgDisplay = cgJoined;
        if (/^y/i.test(cgJoined)) cgDisplay = cgName ? ('Yes, ' + cgName) : 'Yes';
        else if (/^n/i.test(cgJoined)) cgDisplay = 'No';
        else if (cgName) cgDisplay = cgName;
        return { raw:s, payload:p, ts, name, phone, uni, cgJoined, cgName, allergy, receipt, email, cgDisplay };
      }

      function setReview(text){
        if (!text){
          pill.textContent = 'Waiting for scan';
          kvWrap.style.display = 'none';
          rawBox.textContent = '';
          rawBox.style.display = 'none';
          rawToggle.checked = false;
          statusEl.textContent = '';
          statusEl.className = 'status';
          if (kvPay) kvPay.textContent = '';
          confirmBtn.disabled = true;
          markPayBtn.disabled = true;
          return;
        }
        const f = parsePayload(text);
        pill.textContent = 'Scanned';
        kvName.textContent  = f.name || '–';
        kvUni.textContent   = f.uni || '–';
        kvPhone.textContent = f.phone || '–';
        kvEmail.textContent = f.email || '–';
        kvCg.textContent    = f.cgDisplay || '–';
        kvTs.textContent    = f.ts || '–';
        kvCgJ.textContent   = f.cgJoined || '–';
        kvCgN.textContent   = f.cgName || '–';
        kvAll.textContent   = f.allergy || '–';
        kvRec.textContent   = f.receipt || '–';
        if (kvPay) kvPay.textContent = '(not checked yet)';
        kvWrap.style.display = '';
        rawBox.textContent = f.payload;
        statusEl.textContent = '';
        statusEl.className = 'status';
        // re evaluate gate for buttons
        applyGate();
      }

      rawToggle.addEventListener('change', () => {
        rawBox.style.display = rawToggle.checked ? 'block' : 'none';
      });

      function onScanSuccess(text){
        lastScan = text;
        setReview(text);
      }
      function onScanFailure(_){}

      async function chooseCameraId(){
        try {
          const cams = await Html5Qrcode.getCameras();
          if (!cams || !cams.length) return null;
          const back = cams.find(c => /back|rear|environment/i.test(c.label));
          return back ? back.id : cams[0].id;
        } catch { return null; }
      }

      async function startCamera(){
        if (!setupComplete()){
          setupStatus.textContent = 'Complete setup first';
          setupStatus.className = 'status err';
          return;
        }
        try{
          const size = readerSize();
          if (!scanner) scanner = new Html5Qrcode('reader');
          currentCameraId = await chooseCameraId();
          const config = { fps:12, qrbox:{ width:size, height:size }, aspectRatio:1, disableFlip:true,
            showTorchButtonIfSupported:true, formatsToSupport:[ Html5QrcodeSupportedFormats.QR_CODE ] };
          if (currentCameraId) await scanner.start(currentCameraId, config, onScanSuccess, onScanFailure);
          else await scanner.start({ facingMode:'environment' }, config, onScanSuccess, onScanFailure);
          running = true;
          startBtn.style.display = 'none'; stopBtn.style.display = 'block'; refitBtn.style.display = 'block';
          pill.textContent = 'Camera active';
        }catch(e){
          statusEl.textContent = 'Camera error, ' + e.message;
          statusEl.className = 'status err';
        }
      }
      async function stopCamera(){
        if (scanner && running){ try { await scanner.stop(); } catch {} running = false;
          startBtn.style.display = 'block'; stopBtn.style.display = 'none'; refitBtn.style.display = 'none';
          pill.textContent = 'Camera stopped'; }
      }
      async function refitCamera(){ if (!running) return; await stopCamera(); await startCamera(); }
      startBtn.addEventListener('click', startCamera);
      stopBtn.addEventListener('click', stopCamera);
      refitBtn.addEventListener('click', refitCamera);
      const scheduleRefit = () => { if (!running) return; clearTimeout(resizeTimer); resizeTimer = setTimeout(refitCamera, 250); };
      window.addEventListener('resize', scheduleRefit);
      window.addEventListener('orientationchange', scheduleRefit);
      document.addEventListener('visibilitychange', () => { if (document.hidden) stopCamera(); });

      fileInp.addEventListener('change', async (e) => {
        if (!setupComplete()){
          setupStatus.textContent = 'Complete setup first';
          setupStatus.className = 'status err';
          fileInp.value = '';
          return;
        }
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          if (!/image\/jpeg|image\/jpg|image\/png/i.test(file.type)){
            statusEl.textContent = 'Unsupported image, choose JPG or PNG';
            statusEl.className = 'status err';
            fileInp.value = '';
            return;
          }
          if (scanner && running) await stopCamera();
          if (!scanner) scanner = new Html5Qrcode('reader');
          const text = await scanner.scanFile(file, true);
          onScanSuccess(text);
        }catch(err){
          statusEl.textContent = 'File scan failed, ' + (err && err.message ? err.message : 'unknown error');
          statusEl.className = 'status err';
        }finally{ fileInp.value = ''; }
      });

      async function postJSON(payload){
        const r = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        return r.json();
      }

      // Confirm
      confirmBtn.addEventListener('click', async () => {
        if (!lastScan) return;
        if (!setupComplete()){
          setupStatus.textContent = 'Complete setup first';
          setupStatus.className = 'status err';
          return;
        }
        const sheetId = getSheetIdForRequest();
        const target = document.querySelector('input[name="target"]:checked').value;
        confirmBtn.disabled = true;
        statusEl.textContent = 'Updating, please wait';
        statusEl.className = 'status warntext';
        try{
          const j = await postJSON({ scannedText: lastScan, target, sheetId });
          if (typeof j.payment !== 'undefined' && kvPay) kvPay.textContent = j.payment || '–';
          statusEl.textContent = j.message || 'Done';
          statusEl.className = j.ok ? 'status ok' : 'status err';
          if (j.ok && /Checked in row/.test(j.message)){
            lastScan = ''; setReview('');
          } else {
            confirmBtn.disabled = false;
          }
        }catch(err){
          statusEl.textContent = 'Network error, ' + err.message;
          statusEl.className = 'status err';
          confirmBtn.disabled = false;
        }
      });

      // Mark Payment Mistaken
      markPayBtn.addEventListener('click', async () => {
        if (!lastScan) { statusEl.textContent = 'Scan a QR first'; statusEl.className = 'status err'; return; }
        if (!setupComplete()){
          setupStatus.textContent = 'Complete setup first';
          setupStatus.className = 'status err';
          return;
        }
        const sheetId = getSheetIdForRequest();
        statusEl.textContent = 'Marking Payment Mistaken';
        statusEl.className = 'status warntext';
        try{
          const j = await postJSON({ scannedText: lastScan, action: 'markPaymentMistaken', sheetId });
          if (typeof j.payment !== 'undefined' && kvPay) kvPay.textContent = j.payment || 'Payment Mistaken';
          if (j.ok){
            statusEl.textContent = j.message || 'Payment set to Payment Mistaken';
            statusEl.className = 'status ok';
          }else{
            statusEl.textContent = j.message || 'Failed to mark Payment';
            statusEl.className = 'status err';
          }
        }catch(err){
          statusEl.textContent = 'Network error, ' + err.message;
          statusEl.className = 'status err';
        }
      });

      // Clear
      clearBtn.addEventListener('click', () => { lastScan = ''; setReview(''); applyGate(); });

      // Init
      applyGate();
      setReview('');
    });
  </script>
</body>
</html>
